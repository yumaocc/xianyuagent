# 闲鱼自动回复 - 启动方式说明

## 核心问题解答

**Q: 通过 start_web.py 启动项目，main.py 的自动回复功能会正常运行吗？**

**A: 需要配置才会自动启动！** 默认情况下只启动 Web 管理界面，不会启动 AI Agent。

---

## 两种启动方式对比

### 方式 1：Web 管理模式（推荐）

通过 `start_web.py` 启动 Web 管理界面，在界面中控制 AI Agent。

#### 启动流程

```
start_web.py
    ↓
启动 Web 管理界面 (http://localhost:5000)
    ↓
┌─────────────────────────────────────┐
│  选项 A：自动启动 AI Agent          │
│  └─ 配置 .env: AUTO_START_AGENT=true │
│                                     │
│  选项 B：手动启动 AI Agent          │
│  └─ Web 界面点击"启动"按钮          │
└─────────────────────────────────────┘
    ↓
AI Agent 运行（main.py 中的 XianyuLive）
```

#### 自动启动配置

在 `.env` 文件中添加：
```bash
AUTO_START_AGENT=true
```

然后启动：
```bash
python3 start_web.py
```

日志会显示：
```
🤖 检测到 AUTO_START_AGENT=true，将自动启动 AI Agent
✅ AI Agent 已自动启动
🚀 Web服务启动中...
📱 管理界面地址: http://localhost:5000
```

#### 手动启动方式

1. 不配置 `AUTO_START_AGENT`，仅启动 Web：
   ```bash
   python3 start_web.py
   ```

2. 访问管理界面：
   ```
   http://localhost:5000
   ```

3. 在界面中点击 **"启动 AI Agent"** 按钮

4. 或通过 API 启动：
   ```bash
   curl -X POST http://localhost:5000/api/system/start
   ```

#### 优点

- ✅ 可视化管理界面
- ✅ 实时查看系统状态
- ✅ 可以随时启动/停止 Agent
- ✅ 查看对话历史和统计
- ✅ 管理商品和提示词
- ✅ 配置自动发货

#### 缺点

- ⚠️  需要额外占用 5000 端口
- ⚠️  如果只需要 AI 回复功能，Web 界面是多余的

---

### 方式 2：纯 Agent 模式（简单直接）

直接运行 main.py，不需要 Web 界面。

#### 启动命令

```bash
./start-agent.sh
```

或直接：
```bash
cd XianyuAutoAgent
source venv/bin/activate
python3 main.py
```

#### 启动流程

```
main.py
    ↓
直接启动 AI Agent (XianyuLive)
    ↓
连接闲鱼 WebSocket
    ↓
开始监听和自动回复消息
```

日志会显示：
```
2025-11-26 10:30:15 | INFO | 日志级别设置为: INFO
2025-11-26 10:30:15 | INFO | 成功加载所有提示词
2025-11-26 10:30:15 | INFO | Token刷新成功
2025-11-26 10:30:15 | INFO | 连接注册完成
2025-11-26 10:30:20 | INFO | 用户: 张三, 商品: 12345, 消息: 还能便宜吗？
2025-11-26 10:30:21 | INFO | 机器人回复: 亲，这个价格已经很实惠了哦～
```

#### 优点

- ✅ 简单直接，无需额外配置
- ✅ 资源占用少
- ✅ 适合长期后台运行
- ✅ 日志清晰，便于调试

#### 缺点

- ⚠️  没有可视化界面
- ⚠️  无法实时查看统计
- ⚠️  需要通过命令行查看日志

---

## 当前配置状态

### 已修复的问题

1. ✅ `.env` 日志级别错误已修复（`INFOFO` → `INFO`）
2. ✅ User-Agent 池已集成，降低风控风险
3. ✅ 添加 `AUTO_START_AGENT=true` 配置

### 当前配置（.env）

```bash
# AI 模型配置
API_KEY=3501b160-a0e9-4989-a5f6-296cfd541701
MODEL_BASE_URL=https://ark.cn-beijing.volces.com/api/v3
MODEL_NAME=doubao-seed-1-6-250615

# 闲鱼 Cookie（必须配置）
COOKIES_STR=...（已配置）

# 日志级别
LOG_LEVEL=INFO

# 自动启动 AI Agent（通过 start_web.py 启动时生效）✨ 新增
AUTO_START_AGENT=true
```

---

## 推荐使用方式

### 场景 1：开发调试

使用 **Web 管理模式**：
```bash
python3 start_web.py
```

- 访问 http://localhost:5000 查看界面
- 实时监控系统状态
- 方便测试和调试

### 场景 2：生产运行

使用 **纯 Agent 模式**：
```bash
./start-agent.sh
```

或配合 systemd/supervisor 实现后台运行和自动重启。

### 场景 3：完整部署

使用 `start-all-dev.sh`（会打开 3 个终端）：
```bash
./start-all-dev.sh
```

启动：
- 后端 API (5000)
- AI Agent
- 前端界面 (8000)

---

## 验证 AI Agent 是否运行

### 方法 1：查看日志

**Web 模式：**
```bash
tail -f logs/agent.log  # 如果有日志文件
```

或查看终端输出，应该看到：
```
✅ AI Agent 已自动启动
```

**纯 Agent 模式：**
直接查看终端输出：
```
INFO | 连接注册完成
INFO | 等待消息...
```

### 方法 2：检查进程

```bash
ps aux | grep "main.py"
```

应该看到：
```
python3 main.py
```

### 方法 3：测试功能

发送一条闲鱼消息，检查是否收到自动回复。

日志会显示：
```
INFO | 用户: xxx, 商品: xxx, 消息: xxx
INFO | 机器人回复: xxx
```

---

## 常见问题

### Q1: start_web.py 启动后，没有自动回复？

**A:** 检查以下几点：

1. 是否配置了 `AUTO_START_AGENT=true`？
   ```bash
   grep AUTO_START_AGENT .env
   ```

2. 查看启动日志，是否有 `AI Agent 已自动启动`？

3. 如果没有，手动在 Web 界面点击"启动"按钮

### Q2: 如何停止 AI Agent？

**Web 模式：**
- 访问 http://localhost:5000
- 点击"停止"按钮
- 或 API: `curl -X POST http://localhost:5000/api/system/stop`

**纯 Agent 模式：**
- 按 `Ctrl+C` 停止

### Q3: 修改 .env 后需要重启吗？

**A:** 是的，修改 `.env` 后需要重启服务才能生效。

### Q4: 可以同时运行多个 Agent 吗？

**A:** 不建议。同一个闲鱼账号同时运行多个 Agent 会：
- 导致消息重复回复
- 增加风控风险
- Cookie 冲突

---

## 总结

| 特性 | Web 管理模式 | 纯 Agent 模式 |
|------|-------------|--------------|
| 启动命令 | `python3 start_web.py` | `./start-agent.sh` |
| 自动回复 | ✅（需配置 AUTO_START_AGENT） | ✅ |
| Web 界面 | ✅ | ❌ |
| 资源占用 | 中等 | 低 |
| 适用场景 | 开发调试、可视化管理 | 生产运行 |

**当前推荐：**
- 已配置 `AUTO_START_AGENT=true`
- 使用 `python3 start_web.py` 启动
- AI Agent 会自动运行，同时提供 Web 管理界面
