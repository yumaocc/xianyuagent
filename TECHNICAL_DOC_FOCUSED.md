# 🏗️ XianyuAutoAgent 技术文档

## 📋 项目目标

XianyuAutoAgent 专门解决**闲鱼卖家客服自动化**问题，通过智能机器人实现7×24小时自动回复买家咨询，特别针对议价和技术咨询场景进行优化。

**解决的核心问题** 🎯
- 💤 夜间和忙碌时无法及时回复买家
- 🔄 重复性问题消耗大量时间精力  
- 💰 议价过程需要专业策略和技巧
- 🔧 技术类商品需要专业知识回复

---

## 🏛️ 系统架构

### 📊 系统架构流程图

```
┌─────────────────┐
│ 🛒 闲鱼买家      │
│ 发送消息        │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 📡 XianyuLive   │
│ WebSocket接收   │
│ • 消息解密      │
│ • 内容解析      │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 🔍 IntentRouter │
│ 意图识别        │
│ • 关键词匹配    │
│ • 正则表达式    │
│ • AI语义分析    │
└─────────┬───────┘
          │
          ▼
    ┌─────────┐
    │ 🎯 路由决策 │
    └─────────┘
          │
    ┌─────┴─────┬─────────┐
    ▼           ▼         ▼
┌─────────┐ ┌─────────┐ ┌─────────┐
│💰 Price │ │🔧 Tech  │ │💬 Default│
│Agent    │ │Agent    │ │Agent    │
│议价专家  │ │技术专家  │ │通用客服  │
└─────────┘ └─────────┘ └─────────┘
    │           │         │
    └─────┬─────┴─────────┘
          ▼
┌─────────────────┐
│ 🤖 OpenAI API   │
│ 大模型生成回复   │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 📤 发送回复      │
│ 通过WebSocket   │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 💾 SQLite      │
│ 保存对话历史    │
│ 更新统计信息    │
└─────────────────┘
```

### 🔄 消息处理详细流程

```
买家消息 → 系统处理 → AI回复
   │
   ▼
┌─【消息接收阶段】─┐
│ 1️⃣ WebSocket接收 │ ⏱️ 0.1秒
│ 2️⃣ 消息解密      │ ⏱️ 0.1秒  
│ 3️⃣ 提取信息      │ ⏱️ 0.1秒
└─────────┬──────┘
          │
          ▼
┌─【意图识别阶段】─┐
│ 4️⃣ 关键词匹配    │ ⏱️ 0.01秒 (90%场景)
│ 5️⃣ 正则匹配      │ ⏱️ 0.01秒 (5%场景)
│ 6️⃣ AI语义分类    │ ⏱️ 1-2秒  (5%场景)
└─────────┬──────┘
          │
          ▼
┌─【专家处理阶段】─┐
│ 7️⃣ 加载上下文    │ ⏱️ 0.1秒
│ 8️⃣ 专家Agent处理│ ⏱️ 0.1秒
│ 9️⃣ 调用大模型    │ ⏱️ 2-5秒
└─────────┬──────┘
          │
          ▼
┌─【回复发送阶段】─┐
│ 🔟 生成回复内容  │ ⏱️ 0.1秒
│ 1️⃣1️⃣ 发送给买家    │ ⏱️ 0.2秒
│ 1️⃣2️⃣ 保存对话历史  │ ⏱️ 0.1秒
└─────────────────┘
```

### 🎯 意图识别决策树

```
用户消息输入
     │
     ▼
┌─────────────┐
│ 🔍 第一层检查  │
│ 关键词快速匹配 │
└─────┬───────┘
      │
   ┌──▼──┐
   │找到？│
   └──┬──┘
   是 │ 否
     ▼  │
  ┌─────▼───┐
  │💰 价格？ │ 
  │🔧 技术？ │
  └─────────┘
         │ 否
         ▼
   ┌─────────────┐
   │ 🔍 第二层检查  │
   │ 正则表达式匹配 │
   └─────┬───────┘
         │
      ┌──▼──┐
      │找到？│
      └──┬──┘
      是 │ 否
        ▼  │
   ┌─────▼───┐
   │💰 价格？ │
   │🔧 技术？ │
   └─────────┘
          │ 否
          ▼
    ┌─────────────┐
    │ 🤖 第三层检查  │
    │ AI语义理解    │
    └─────┬───────┘
          │
          ▼
    ┌─────────────┐
    │ 🎯 最终路由    │
    │ 💰💬🔧      │
    └─────────────┘
```

---

## 🧠 核心技术实现

### 💰 PriceAgent 议价专家

**🎯 核心算法：动态温度调节**
```python
def _calc_temperature(self, bargain_count: int) -> float:
    # 议价次数越多，回复越灵活
    return min(0.3 + bargain_count * 0.15, 0.9)
```

**📊 议价策略演进**

| 议价轮次 | AI温度 | 回复策略 | 示例话术 |
|----------|--------|----------|----------|
| 第1次 | 0.45 | 坚持原价 | "这个价格已经很实惠了" |
| 第2次 | 0.60 | 小幅松动 | "可以稍微优惠一点点" |  
| 第3次 | 0.75 | 明显让价 | "看您诚心，给个友情价" |
| 第4次+ | 0.90 | 接近底价 | "真的是最后价格了" |

**💡 议价优势**
- ✅ 模拟真实人工议价心理
- ✅ 根据轮次自动调整策略
- ✅ 避免一开始就大幅降价

### 🔧 TechAgent 技术专家

**🔍 网络搜索增强**
```python
extra_body = {
    "enable_search": True,  # 启用实时搜索
}
```

**📋 处理的技术咨询**
- 产品参数对比："这个和XX有什么区别？"
- 规格查询："支持什么接口？"
- 兼容性问题："能连我的设备吗？"
- 使用方法："这个功能怎么用？"

**⭐ 技术优势**
- ✅ 实时搜索最新信息
- ✅ 专业术语优化
- ✅ 准确的技术参数

### 👨‍💼 人工接管机制

**🎮 切换方式**
- 卖家发送 `"。"` 即可切换模式
- 支持自定义切换关键词
- 会话级独立控制（不影响其他买家）

**⏰ 自动恢复**
- 1小时无活动自动恢复AI模式
- 防止因忘记切换导致的服务中断

### 🔄 人工接管流程图

```
正常AI自动回复模式
        │
        ▼
┌─────────────────┐
│ 🛒 买家发送消息   │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐     ┌─────────────────┐
│ 🤖 系统自动处理   │ ←─→ │ 🛒 卖家想要接管   │
│ AI回复买家      │     │ 发送"。"切换     │
└─────────┬───────┘     └─────────┬───────┘
          │                       │
          │                       ▼
          │               ┌─────────────────┐
          │               │ 🔄 模式切换      │
          │               │ AI → 人工模式   │
          │               └─────────┬───────┘
          │                         │
          ▼                         ▼
┌─────────────────┐     ┌─────────────────┐
│ 💬 继续AI回复    │     │ 👨‍💼 人工接管模式  │
└─────────────────┘     │ • 停止AI回复     │
                        │ • 卖家手动处理    │
                        │ • 记录人工消息    │
                        └─────────┬───────┘
                                  │
                        ┌─────────▼───────┐
                        │ 🔄 恢复AI模式？   │
                        └─────────┬───────┘
                                  │
                        ┌─────────┴─────────┐
                        │                   │
                        ▼                   ▼
                ┌─────────────────┐ ┌─────────────────┐
                │ 🎮 手动切换      │ │ ⏰ 自动恢复      │
                │ 再次发送"。"     │ │ 1小时无活动     │
                └─────────┬───────┘ └─────────┬───────┘
                          │                   │
                          └─────────┬─────────┘
                                    ▼
                          ┌─────────────────┐
                          │ 🤖 恢复AI模式    │
                          │ 继续自动回复     │
                          └─────────────────┘
```

---

## 💾 数据存储设计

### 🗃️ SQLite数据库表结构

**📨 messages - 对话记录**
```sql
CREATE TABLE messages (
    id INTEGER PRIMARY KEY,
    user_id TEXT,           -- 买家ID
    item_id TEXT,           -- 商品ID  
    chat_id TEXT,           -- 会话ID(关键字段)
    role TEXT,              -- user/assistant
    content TEXT,           -- 消息内容
    timestamp DATETIME      -- 时间
);
```

**📊 chat_bargain_counts - 议价统计**
```sql
CREATE TABLE chat_bargain_counts (
    chat_id TEXT PRIMARY KEY,  -- 会话ID
    count INTEGER,             -- 议价次数  
    last_updated DATETIME      -- 更新时间
);
```

**📦 items - 商品缓存**
```sql
CREATE TABLE items (
    item_id TEXT PRIMARY KEY,  -- 商品ID
    data TEXT,                 -- 商品详情JSON
    price REAL,               -- 价格
    description TEXT          -- 描述
);
```

**🎯 设计优势**
- 基于chat_id独立管理每个对话
- 自动统计议价轮次，优化策略
- 商品信息缓存，减少API调用

---

## 🚀 部署和运行

### ⚙️ 环境配置

**必需配置 (.env文件)**
```env
# 🔑 AI服务配置
API_KEY=your_openai_api_key
MODEL_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
MODEL_NAME=qwen-max

# 🍪 闲鱼登录凭证
COOKIES_STR=your_xianyu_cookies

# 🎮 人工接管关键词
TOGGLE_KEYWORDS=。
```

**可选配置**
```env
# ⏱️ 系统参数调优
HEARTBEAT_INTERVAL=15        # 心跳间隔
TOKEN_REFRESH_INTERVAL=3600  # Token刷新间隔
LOG_LEVEL=INFO              # 日志级别
```

### 🐳 Docker部署 (推荐)

**1. 构建镜像**
```bash
docker build -t xianyu-agent .
```

**2. 运行容器**
```bash
docker run -d \
  --name xianyu-agent \
  -p 5000:5000 \
  -v ./data:/app/data \
  -v ./.env:/app/.env \
  xianyu-agent
```

### 🛠️ 直接运行

**1. 安装依赖**
```bash
pip install -r requirements.txt
```

**2. 启动服务**
```bash
python main.py
```

---

## 📊 系统监控

### 📱 Web管理界面

访问 `http://localhost:5000` 查看：

**📈 实时状态**
- WebSocket连接状态
- 消息处理统计  
- AI调用响应时间
- 系统运行时间

**💬 对话管理**
- 查看所有活跃对话
- 查看对话历史记录
- 手动切换人工接管模式
- 发送人工消息

**🤖 Agent状态**
- 各专家调用频次
- 意图识别准确率
- 重新加载提示词模板

### 📝 日志监控

**日志级别说明**
- 🐛 DEBUG：调试信息，开发时使用
- ℹ️ INFO：正常业务流程，记录用户消息和回复
- ⚠️ WARNING：异常情况，如API调用失败
- ❌ ERROR：系统错误，需要及时处理

**关键日志示例**
```
INFO - 用户: 张三 (ID: 12345), 商品: 67890, 消息: 能便宜点吗？
INFO - 意图识别完成: price  
INFO - 机器人回复: 这个价格已经很实惠了，质量很好的
```

---

## ⚡ 性能优化

### 🔌 连接层优化

**心跳机制**
- 15秒发送一次心跳包
- 5秒内无响应视为连接异常
- 自动重连机制

**Token管理**  
- 每小时自动刷新Token
- Token失效时自动重新登录
- 防止因认证问题导致服务中断

### 💾 数据层优化

**数据库索引**
```sql
CREATE INDEX idx_chat_id ON messages (chat_id);     -- 会话查询
CREATE INDEX idx_timestamp ON messages (timestamp); -- 时间排序
```

**缓存策略**
- 商品信息本地缓存，避免重复API调用
- 对话上下文内存缓存，加快查询速度
- 提示词模板缓存，支持热更新

### 🤖 AI调用优化

**参数调优**
- max_tokens: 500 (控制回复长度)
- timeout: 30秒 (避免长时间等待)  
- temperature: 动态调节 (根据场景调整)

**错误处理**
- API调用失败自动重试
- 超时时使用预设回复
- 记录详细错误日志便于排查

---

## 🛡️ 安全和合规

### 🚫 内容安全过滤

**敏感词过滤**
```python
blocked_phrases = ["微信", "QQ", "支付宝", "银行卡", "线下"]
```
- 防止引导用户到其他平台交易
- 确保交易在闲鱼平台内进行
- 触发时返回标准安全提醒

### 🔐 数据安全

**敏感信息保护**
- Cookie等认证信息加密存储
- 用户对话数据本地存储，不上传云端
- 定期清理过期日志和数据

**访问控制**
- Web管理界面仅限本地访问
- 重要操作需要确认
- 完整的操作日志记录

---

## 💡 使用建议

### 🎯 最佳实践

**提示词优化**
- 定期根据实际对话效果调整提示词
- 针对具体商品类别定制专业回复
- 收集好的回复案例用于模板优化

**监控和维护**
- 每天查看错误日志，及时处理异常
- 定期检查议价效果，调整策略参数
- 关注买家反馈，持续改进回复质量

**人工干预**
- 复杂问题及时切换人工模式
- 重要客户优先人工接待  
- 新商品上架初期多关注自动回复效果

### ⚠️ 注意事项

**平台合规**
- 回复内容符合闲鱼平台规范
- 避免被平台识别为机器人行为
- 保持合理的回复频率和时间

**业务风险**
- 重要交易建议人工确认
- 定期备份对话数据和系统配置
- 监控系统运行状态，及时处理故障

---

## 🎉 总结

XianyuAutoAgent 专注解决闲鱼卖家的客服自动化需求，通过智能议价和技术咨询功能，显著提升客服效率和买家体验。

**🎯 核心优势**
- ✅ 专门针对闲鱼平台优化
- ✅ 智能议价策略，提高成交率  
- ✅ 24小时自动值守，不错过任何咨询
- ✅ 简单部署，维护成本低

**💰 实际价值**
- 节省90%以上的重复性客服工作
- 夜间和忙碌时段不再错失潜在买家
- 专业的技术咨询提升店铺专业度
- 智能议价策略平衡价格和成交率