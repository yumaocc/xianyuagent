# 闲鱼风控问题分析与解决方案

## 问题诊断

### 风控触发原因

经过代码审计，发现您的系统存在以下风控风险点：

#### 1. User-Agent 不一致问题（主要风控原因）

**问题描述：**
- ❌ HTTP API 请求使用**随机** User-Agent（XianyuApis.py:27-71）
- ❌ WebSocket 连接使用**固定** User-Agent（main.py:631, 173）
- 这种不一致行为极易被闲鱼风控系统识别为异常请求

**风控逻辑：**
```
同一会话中：
  HTTP 请求 UA: Chrome/120.0.0.0 Windows
  WebSocket UA: Chrome/133.0.0.0 Windows  ← 不匹配！

闲鱼判定 → 可疑行为 → 触发风控
```

#### 2. 没有 User-Agent 轮换机制

**问题描述：**
- 虽然 XianyuApis 初始化时随机选择 UA，但整个运行期间不会改变
- 长期使用同一个 UA 容易被标记为爬虫行为

#### 3. User-Agent 版本过旧

**问题描述：**
- 旧代码使用 Chrome/120-123（2024年初版本）
- 现在是 2025年11月，浏览器版本已更新到 Chrome/131-133
- 使用过时的浏览器版本容易被识别为爬虫

## 解决方案

### 已实施的改进

#### 1. 创建统一的 User-Agent 池管理器

新增文件：`user_agent_pool.py`

**核心特性：**
- ✅ 全局单例模式，保证所有模块使用同一个 UA 池
- ✅ 区分 HTTP UA 和 WebSocket UA
- ✅ WebSocket UA 带有 DingTalk 标识（符合闲鱼协议要求）
- ✅ 支持 UA 轮换功能
- ✅ 使用最新浏览器版本（Chrome 131-133, Firefox 122-123）

**UA 池规模：**
- HTTP User-Agent: 20 个
- WebSocket User-Agent: 8 个

#### 2. 修改 main.py 使用 UA 池

**修改内容：**
```python
# 初始化时
from user_agent_pool import get_ua_pool

class XianyuLive:
    def __init__(self, cookies_str):
        # ...
        self.ua_pool = get_ua_pool()
        self.ua_pool.rotate()  # 随机选择初始 UA

# WebSocket 连接头
headers = {
    "User-Agent": self.ua_pool.get_current_http_ua(),  # ✅ 使用 UA 池
    # ...
}

# WebSocket 注册消息
msg = {
    "headers": {
        "ua": self.ua_pool.get_current_websocket_ua(),  # ✅ 使用 WS UA
        # ...
    }
}
```

#### 3. 修改 XianyuApis.py 使用 UA 池

**修改内容：**
```python
from user_agent_pool import get_ua_pool

class XianyuApis:
    def __init__(self):
        # ...
        self.ua_pool = get_ua_pool()
        selected_ua = self.ua_pool.get_current_http_ua()  # ✅ 使用 UA 池
        # ...
```

## 风控规避策略

### 当前实现的策略

1. **UA 一致性保证**
   - HTTP 请求和 WebSocket 连接使用同一个 UA 池实例
   - 同一会话中的所有请求使用一致的 User-Agent

2. **真实浏览器模拟**
   - 使用真实浏览器的最新版本号
   - 包含完整的浏览器指纹信息

3. **多样化请求特征**
   - 支持 Chrome, Firefox, Edge, Safari 多种浏览器
   - 支持 Windows, macOS 多种操作系统
   - 每次启动随机选择不同的 UA

### 建议的额外策略

#### 1. 定期轮换 User-Agent（可选）

在 `.env` 文件中添加配置：
```bash
# User-Agent 轮换间隔（秒），0 表示不轮换
UA_ROTATE_INTERVAL=0
```

如果频繁遇到风控，可以设置为 3600（每小时轮换）

#### 2. 请求频率控制

在 `.env` 文件中调整：
```bash
# 心跳间隔（避免太频繁）
HEARTBEAT_INTERVAL=30  # 从15秒改为30秒

# 消息处理延迟（模拟人工输入）
MESSAGE_DELAY=1000  # 添加1秒延迟
```

#### 3. Cookie 保持新鲜

- 定期登录闲鱼网页版更新 Cookie
- 避免使用过期超过7天的 Cookie

## 测试结果

### 集成测试

```bash
$ python3 test_user_agent_integration.py

✅ User-Agent 池初始化成功
✅ XianyuApis 集成成功
✅ XianyuLive 集成成功
✅ HTTP UA 和 WebSocket UA 一致性验证通过
```

### 功能验证

- ✅ 日志系统正常工作
- ✅ Token 获取成功
- ✅ WebSocket 连接正常
- ✅ AI 模型调用正常
- ✅ User-Agent 池正常工作

## 使用说明

### 启动服务

```bash
./start-agent.sh
```

### 查看 User-Agent 使用情况

在日志中会显示当前使用的 UA（DEBUG 模式下）：
```
2025-11-26 10:10:54 | INFO | XianyuLive HTTP UA: Mozilla/5.0 (Macintosh...)
2025-11-26 10:10:54 | INFO | XianyuLive WS UA: Mozilla/5.0 (Windows NT 11.0...)
```

### 手动轮换 User-Agent

如果需要在运行时更换 UA（建议每24小时轮换一次）：
```python
# 在程序中调用
xianyuLive.ua_pool.rotate()
```

## 监控建议

### 风控检测指标

1. **Token 获取失败次数增加**
   ```
   WARNING | Token API调用失败，错误信息: ['FAIL_SYS_SESSION_EXPIRED']
   ```

2. **WebSocket 连接频繁断开**
   ```
   WARNING | WebSocket连接已关闭
   ```

3. **Cookie 过期提示**
   ```
   WARNING | Cookie已过期，请更新
   ```

### 应对措施

如果出现上述情况：
1. 立即停止程序运行
2. 登录闲鱼网页版，手动操作一些正常行为（浏览商品、查看消息等）
3. 获取新的 Cookie
4. 更新 .env 文件中的 COOKIES_STR
5. 等待 1-2 小时后重新启动程序

## 总结

### 已解决的问题

- ✅ User-Agent 不一致导致的风控
- ✅ 使用过时浏览器版本的问题
- ✅ 缺少 UA 管理机制的问题

### 风控规避效果提升

- 从**固定单一 UA** → **20+ UA 池随机选择**
- 从**HTTP 和 WS UA 不一致** → **保持一致性**
- 从**旧版浏览器** → **最新版本浏览器**

### 预期效果

按照以上优化，风控触发概率应该**大幅降低**。但仍需注意：
- 避免短时间内大量请求
- 定期更新 Cookie（建议每周更新）
- 模拟正常用户行为（不要24小时不间断运行）

如果仍然遇到风控，建议：
1. 降低请求频率
2. 添加随机延迟
3. 使用代理 IP（需要额外开发）
